#!/usr/bin/env ruby -w
# frozen_string_literal: true
require "pathname"

$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
$LOAD_PATH.unshift File.expand_path("../test", __dir__)

# janky way to avoid opt parsing
files, argv = ARGV.map{ [Dir["test/**/*#{it}*"].grep(/\.rb$/), it] }.partition{ it.first.any? }
files = files.map(&:first).flatten
files = Dir["test/**/*.rb"] if files.empty?
ARGV.replace(argv.map(&:last))
def opt!(*xs) = xs.flatten.map{ ARGV.delete it }.any?

require "minitest/reporters"
require "minitest/debugger"  if opt! %w[ -d --debug --debugger ]
require "minitest/fail_fast" if opt! %w[ -f --fail-fast ]
$VERBOSE = true if opt! %w[ -w --warnings ]
if opt! %w[ -c --color ]
  # Minitest::Reporters.use! Minitest::Reporters::SpecReporter.new
  Minitest::Reporters.use! Minitest::Reporters::DefaultReporter.new(color: true)
end

if opt! %w[ -o --order ]
  module Minitest
    class Runnable
      # run test classes in order
      class << @@runnables
        def shuffle = itself
      end
    end

    class Test
      @@test_order_list = Hash.new{|h, k| h[k] = [] }

      class << self

        def method_added(name)
          super
          @@test_order_list[self] << name.to_s if name.to_s.start_with?("test_")
        end

        alias_method :runnable_methods_before, :runnable_methods
        def runnable_methods = @@test_order_list[self] || runnable_methods_before

      end
    end
  end
end

# this reporter prints just the failed test file/methods, and cmd to run each file
Minitest::Reporters.use!(
  Class.new(Minitest::Reporters::BaseReporter) do
    def start
      @fails = Hash.new{|h, k| h[k] = [] }
    end

    def record(r)
      return unless r.failure
      file, lno = r.source_location
      file = Pathname.new(file).relative_path_from Dir.pwd
      method = r.name
      @fails[file] << [method, lno]
    end

    def report
      @fails.map do |f,mls|
        n = f
        puts n
        ms = mls.map do |m,n|
          m = m.sub(/^test_/, '').gsub(?_, ' ')
          fn = "#{f}:#{n}"
          [m, fn]
        end
        d = ms.map{ it.last.size }.max
        # d = 50
        puts ms.map{|m,fn| "  - [ %-#{d}s ]  %s" % [fn, m] }
        n
      end.each do |n|
        puts "bin/test #{File.basename(n, '.rb')}"
      end
    end
  end.new
) if opt! %w[ -l --list ]

require "minitest/autorun"

files.each{ require_relative "../#{it}" }
